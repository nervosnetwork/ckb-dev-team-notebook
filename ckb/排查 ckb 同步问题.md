# 排查 ckb 同步问题

## ckb 是怎么同步的

ckb 全节点目前的同步流程分为两大块：

1. 随机找一个连上的节点，尝试向其拿到完整的链的所有 header
2. 逐一验证 headers
3. 在同一时间，向所有 outbound 节点请求下载已经验证过了的 header 对应的 block 数据
4. 逐一验证 block 数据

header 下载困难将会逐出节点，找另外的节点尝试。

block 下载有一个自适应的调度器，原理是博弈论，尽可能以历史下载和处理的速度调整所有能下载的节点的任务数，如果归零则被逐出（保护节点和白名单除外），这意味着当前下载节点大部分将是在能观测到的平均值以上的节点。

注意，如果保护节点或者白名单任务数归零，则意味着下载速度的上限将被降低。

但，非常遗憾的是，虽然 block 下载是并行的，但处理过程是串行的，写入数据库的操作也是串行的：

- 发出下载请求：并行
- 下载到本地：并行
- 验证 block：串行
- 验证 block 中的交易：并行
- 写入数据库：串行

并且，验证 block 的过程会阻塞网络消息的接收。

## 常见的无法同步原因

1. 本机无网络
2. 初始化错误导致无法连上节点
3. 无法找到有效的节点（可能是由于 peer store 存储的数据随机取出并连接过程过于冗长，并且未能及时找到有效的节点地址
4. 复制了别人的数据，并继承了已有的 peer id，导致被部分节点驱逐
5. 未知的 bug

## 用户可以做的事情

我个人推荐 4 核 8 G 的机器同步，这应该是现在比较常见的机器类型，只要硬盘和 CPU 不是太差，理论上都应该可以同步（我个人用电脑连手机热点都可以进行同步）

针对第三点问题，用户可以做的事情是：

1. 关掉 ckb 进程
2. 删除对应文件夹 `data/network/peer_store/` 下的所有数据
3. 重启 ckb，观察同步情况

针对第四点问题，用户可以做的事情是：

1. 关掉 ckb 进程
2. 删除文件 `data/network/secret_key`
3. 重启 ckb，观察同步情况

用户如果对自己的网络状况有更细致的了解，可以通过修改 `ckb.toml` 中 `[network]` 章节的 bootnodes list 和 whitelist_peers list 去定制节点同步的对象，可以得到更好的体验。

### 针对 neuron 用户

建议钱包用户单独启动 ckb 进程，不要用内置的节点

### 观察网络状况的 rpc

[get_peers](https://github.com/driftluo/ckb/tree/develop/rpc#method-get_peers)：查看网络连接情况和每个节点的同步状态，如发现某节点的 `can_fetch_count` 为 0x0，并且长期没有逐出，建议手动调用 `remove_node` rpc 进行清理，0.32 版本以下的节点，可以酌情移除
[sync_state](https://github.com/driftluo/ckb/tree/develop/rpc#method-sync_state)：查看全局同步状态